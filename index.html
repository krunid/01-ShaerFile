<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: 'Prompt', sans-serif;
            background-image: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-color: #f3f4f6; /* Fallback color */
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.70); /* Adjusted for better readability */
            backdrop-filter: blur(12px);
            border-radius: 16px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .purple-btn { background-color: #8A2BE2; transition: all 0.3s ease; }
        .purple-btn:hover:not(:disabled) { background-color: #7209b7; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(138, 43, 226, 0.4); }
        .purple-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .yellow-accent { border-left: 4px solid #FFD700; }
        .form-input { transition: border-color 0.3s ease, box-shadow 0.3s ease; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #8A2BE2; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background-color: #8A2BE2; color: white; padding: 12px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #ddd; }
        th.no-wrap, td.no-wrap { white-space: nowrap; }
        tr:nth-child(even) { background-color: rgba(138, 43, 226, 0.05); }
        tr:not(#noResultsRow):hover { background-color: rgba(138, 43, 226, 0.1); }
        .logo-container { display: flex; justify-content: center; margin-bottom: 16px; }
        .logo-image { max-height: 200px; object-fit: contain; }
        .instructions { background-color: rgba(255, 215, 0, 0.15); border-left: 4px solid #FFD700; padding: 16px; margin-bottom: 24px; border-radius: 0 8px 8px 0; }
        .pagination-btn { padding: 8px 16px; border: 1px solid #ddd; background-color: white; border-radius: 6px; transition: all 0.2s ease; }
        .pagination-btn:hover:not(:disabled) { background-color: #f0e6ff; border-color: #8A2BE2; }
        .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; background-color: #f3f4f6; }
        .nav-button {
            padding: 10px 20px;
            font-weight: 500;
            color: #4a044e;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .nav-button:hover { background-color: rgba(255, 255, 255, 0.3); }
        .nav-button.active { color: #8A2BE2; border-bottom-color: #8A2BE2; }
        /* Dashboard styles */
        .stat-card { background-color: rgba(255, 255, 255, 0.5); padding: 1rem; border-radius: 0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <nav class="bg-white/70 backdrop-blur-sm shadow-md sticky top-0 z-50 mb-8">
        <div class="container mx-auto flex justify-center items-center">
            <button id="navBtnRegister" class="nav-button active">‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button id="navBtnTable" class="nav-button">‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <button id="navBtnDashboard" class="nav-button">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8 flex-grow">
        <div id="page-register">
            <div class="glass-effect p-6 md:p-8 mb-8 max-w-3xl mx-auto">
                <div class="logo-container"><img src="https://krunid.github.io/knid13/krunid-logo.png" alt="Logo" class="logo-image"></div>
                <h1 id="formTitle" class="text-2xl md:text-3xl font-bold text-center mb-6 text-purple-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå</h1>
                <div class="instructions mb-6"><h3>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3><ol><li>‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</li><li>‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ</li><li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</li><li>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</li><li>‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°</li></ol></div>
                <form id="registrationForm" class="space-y-6">
                    <div class="yellow-accent pl-3"><label for="name" class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" id="name" name="name" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 form-input"></div>
                    <div class="yellow-accent pl-3"><label for="email" class="block text-sm font-medium text-gray-700 mb-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label><input type="email" id="email" name="email" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 form-input"></div>
                    <div class="yellow-accent pl-3"><label for="program" class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°</label><select id="program" name="program" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 form-input"><option value="" disabled selected>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°</option></select></div>
                    <div class="text-center pt-4"><button type="submit" id="submitBtn" class="purple-btn text-white px-6 py-3 rounded-md font-medium shadow-md" disabled>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå</button></div>
                </form>
                <div id="loadingIndicator" class="hidden"><div class="loader"></div><p class="text-center text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p></div>
            </div>
        </div>

        <div id="page-table" class="hidden">
            <div class="glass-effect p-6 md:p-8 max-w-5xl mx-auto mb-8">
                <h2 class="text-xl md:text-2xl font-bold mb-4 text-purple-800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4"><div class="relative w-full sm:w-auto flex-grow"><input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠, ‡∏≠‡∏µ‡πÄ‡∏°‡∏•, ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°..." class="w-full pl-4 pr-10 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 form-input"><div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"><svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg></div></div><button id="reloadBtn" title="‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà" class="flex-shrink-0 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md transition-transform duration-200 ease-in-out hover:scale-105 flex items-center gap-2 w-full sm:w-auto justify-center"><svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg><span>‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà</span></button></div>
                <div id="tableLoading" class="text-center py-4"><div class="loader"></div><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p></div>
                <div id="tableContainer" class="table-container hidden"><table><thead><tr><th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th class="no-wrap">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th><th>‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°</th><th class="no-wrap">‡πÄ‡∏ß‡∏•‡∏≤</th></tr></thead><tbody id="registrationData"></tbody></table></div>
                <div id="paginationContainer" class="flex flex-col sm:flex-row justify-between items-center mt-4 gap-4 hidden"><div class="flex gap-2"><button id="firstPageBtn" class="pagination-btn">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button><button id="prevPageBtn" class="pagination-btn">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button></div><div id="pageInfo" class="text-gray-700 font-medium"></div><div class="flex gap-2"><button id="nextPageBtn" class="pagination-btn">‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button><button id="lastPageBtn" class="pagination-btn">‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢</button></div></div>
            </div>
        </div>

        <div id="page-dashboard" class="hidden">
            <div class="glass-effect p-6 md:p-8 max-w-6xl mx-auto">
                <h2 class="text-2xl md:text-3xl font-bold mb-6 text-purple-800 text-center">üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h2>
                <div id="dashboardLoading" class="text-center py-6">
                    <div class="loader"></div>
                    <p class="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥...</p>
                </div>
                <div id="dashboardContent" class="hidden grid md:grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="stat-card">
                        <h3 class="font-bold text-lg text-purple-700 mb-3">‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°</h3>
                        <ul id="program-stats" class="space-y-2 text-sm max-h-96 overflow-y-auto"></ul>
                    </div>
                    <div class="stat-card">
                        <h3 class="font-bold text-lg text-purple-700 mb-3">‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</h3>
                        <ul id="name-stats" class="space-y-2 text-sm max-h-96 overflow-y-auto"></ul>
                    </div>
                    <div class="stat-card">
                        <h3 class="font-bold text-lg text-purple-700 mb-3">‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏≠‡∏µ‡πÄ‡∏°‡∏•</h3>
                        <ul id="email-stats" class="space-y-2 text-sm max-h-96 overflow-y-auto"></ul>
                    </div>
                </div>
                <div id="dashboardError" class="hidden text-center py-6 text-red-500"></div>
            </div>
        </div>
    </div>

    <footer class="bg-purple-900 text-white py-6">
        <div class="container mx-auto px-4"><div class="flex flex-col md:flex-row justify-between items-center"><div class="mb-4 md:mb-0"><h3 class="text-lg font-semibold">‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå</h3><p class="text-yellow-300 text-sm">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏á‡πà‡∏≤‡∏¢ ‡πÑ‡∏î‡πâ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p></div><div class="text-sm text-gray-300"><p>¬© 2024 ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå</p><p>‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ Canva Code</p></div></div></div>
    </footer>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxexukmxxGsjUNXPHki4tiHkXrQZuveRFHn9oFhgkw23Dfi9xAmu8uW_MjvySZP5xo2LQ/exec';
        const SHEET_ID = '1gFUtqSFzDjUGPXR79Rn1_GdKzidQ5LT1cVw3NahpkZU';
        const PAGE_SIZE = 20;

        let currentPage = 1;
        let totalPages = 1;
        let allRegistrationsData = null; // Cache for dashboard data
        
        document.addEventListener('DOMContentLoaded', function() {
            // --- Page switching elements ---
            const pages = {
                register: document.getElementById('page-register'),
                table: document.getElementById('page-table'),
                dashboard: document.getElementById('page-dashboard')
            };
            const navButtons = {
                register: document.getElementById('navBtnRegister'),
                table: document.getElementById('navBtnTable'),
                dashboard: document.getElementById('navBtnDashboard')
            };

            function showPage(pageKey) {
                Object.keys(pages).forEach(key => {
                    pages[key].classList.add('hidden');
                    navButtons[key].classList.remove('active');
                });
                pages[pageKey].classList.remove('hidden');
                navButtons[pageKey].classList.add('active');
            }

            navButtons.register.addEventListener('click', () => showPage('register'));
            navButtons.table.addEventListener('click', () => showPage('table'));
            navButtons.dashboard.addEventListener('click', () => {
                showPage('dashboard');
                if (!allRegistrationsData) { // Fetch data only once
                    fetchDashboardData();
                }
            });

            // --- Initial data fetching ---
            fetchProgramOptions();
            fetchRecentRegistrations(currentPage);

            // --- Form logic ---
            const form = document.getElementById('registrationForm');
            const submitBtn = document.getElementById('submitBtn');
            const requiredInputs = form.querySelectorAll('[required]');
            
            function checkFormValidity() {
                let allValid = true;
                requiredInputs.forEach(input => { if (!input.value) allValid = false; });
                submitBtn.disabled = !allValid;
            }

            requiredInputs.forEach(input => input.addEventListener('input', checkFormValidity));
            form.addEventListener('submit', (e) => { e.preventDefault(); submitForm(); });
            checkFormValidity();
            
            // --- Table logic ---
            const searchInput = document.getElementById('searchInput');
            const reloadBtn = document.getElementById('reloadBtn');
            const firstPageBtn = document.getElementById('firstPageBtn');
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const lastPageBtn = document.getElementById('lastPageBtn');
            
            searchInput.addEventListener('input', handleSearch);
            reloadBtn.addEventListener('click', () => fetchRecentRegistrations(1));
            firstPageBtn.addEventListener('click', () => { if (currentPage > 1) fetchRecentRegistrations(1); });
            prevPageBtn.addEventListener('click', () => { if (currentPage > 1) fetchRecentRegistrations(currentPage - 1); });
            nextPageBtn.addEventListener('click', () => { if (currentPage < totalPages) fetchRecentRegistrations(currentPage + 1); });
            lastPageBtn.addEventListener('click', () => { if (currentPage < totalPages) fetchRecentRegistrations(totalPages); });
        });

        // --- DASHBOARD FUNCTIONS ---
        function fetchDashboardData() {
            const loadingEl = document.getElementById('dashboardLoading');
            const contentEl = document.getElementById('dashboardContent');
            const errorEl = document.getElementById('dashboardError');
            
            loadingEl.classList.remove('hidden');
            contentEl.classList.add('hidden');
            errorEl.classList.add('hidden');

            fetch(`${SCRIPT_URL}?action=getAllData&sheetId=${SHEET_ID}`)
                .then(response => response.json())
                .then(data => {
                    loadingEl.classList.add('hidden');
                    if (data.success && data.registrations) {
                        allRegistrationsData = data.registrations; // Cache data
                        processAndDisplayDashboard(allRegistrationsData);
                        contentEl.classList.remove('hidden');
                    } else {
                        throw new Error(data.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÑ‡∏î‡πâ');
                    }
                })
                .catch(error => {
                    console.error('Error fetching dashboard data:', error);
                    loadingEl.classList.add('hidden');
                    errorEl.textContent = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}. ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° action 'getAllData' ‡πÉ‡∏ô Google Apps Script ‡πÅ‡∏•‡πâ‡∏ß`;
                    errorEl.classList.remove('hidden');
                });
        }

        function processAndDisplayDashboard(data) {
            const counts = { program: {}, name: {}, email: {} };
            
            data.forEach(reg => {
                if(reg.program) counts.program[reg.program] = (counts.program[reg.program] || 0) + 1;
                if(reg.name) counts.name[reg.name] = (counts.name[reg.name] || 0) + 1;
                if(reg.email) counts.email[reg.email] = (counts.email[reg.email] || 0) + 1;
            });

            displayCountList('program-stats', counts.program);
            displayCountList('name-stats', counts.name);
            displayCountList('email-stats', counts.email);
        }

        function displayCountList(elementId, countData) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';

            const sortedItems = Object.entries(countData).sort(([, a], [, b]) => b - a);

            if (sortedItems.length === 0) {
                container.innerHTML = '<li class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>';
                return;
            }

            sortedItems.forEach(([item, count]) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-gray-50 p-2 rounded';
                li.innerHTML = `
                    <span class="truncate pr-2" title="${item}">${item}</span>
                    <span class="font-bold bg-purple-200 text-purple-800 text-xs px-2 py-1 rounded-full flex-shrink-0">${count}</span>
                `;
                container.appendChild(li);
            });
        }

        // --- COMMON AND TABLE FUNCTIONS ---
        function updatePaginationControls() {
            const pageInfo = document.getElementById('pageInfo');
            const firstPageBtn = document.getElementById('firstPageBtn');
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const lastPageBtn = document.getElementById('lastPageBtn');
            const paginationContainer = document.getElementById('paginationContainer');

            if (totalPages > 1) {
                paginationContainer.classList.remove('hidden');
                pageInfo.textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${currentPage} ‡∏à‡∏≤‡∏Å ${totalPages}`;
                firstPageBtn.disabled = currentPage === 1;
                prevPageBtn.disabled = currentPage === 1;
                nextPageBtn.disabled = currentPage === totalPages;
                lastPageBtn.disabled = currentPage === totalPages;
            } else {
                paginationContainer.classList.add('hidden');
            }
        }

        function handleSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const tableBody = document.getElementById('registrationData');
            const rows = tableBody.getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                if (row.id === 'noResultsRow') continue;
                const rowText = row.textContent || row.innerText;
                row.style.display = rowText.toLowerCase().includes(searchTerm) ? '' : 'none';
            }
        }

        function formatThaiBuddhistDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                return date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric', calendar: 'buddhist', timeZone: 'Asia/Bangkok' });
            } catch (error) { console.error("Error formatting date:", dateString, error); return dateString; }
        }

        function fetchProgramOptions() {
            fetch(`${SCRIPT_URL}?action=getPrograms&sheetId=${SHEET_ID}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (data.title) { document.getElementById('formTitle').textContent = data.title; }
                        const programSelect = document.getElementById('program');
                        programSelect.innerHTML = '<option value="" disabled selected>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°</option>';
                        data.programs.forEach(program => {
                            const option = document.createElement('option');
                            option.value = program;
                            option.textContent = program;
                            programSelect.appendChild(option);
                        });
                    } else { showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÑ‡∏î‡πâ', data.message || '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'); }
                })
                .catch(error => { console.error('Error fetching programs:', error); showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ'); });
        }
        
        function fetchRecentRegistrations(page) {
            const tableLoading = document.getElementById('tableLoading');
            const tableContainer = document.getElementById('tableContainer');
            const tableBody = document.getElementById('registrationData');
            
            tableLoading.classList.remove('hidden');
            tableContainer.classList.add('hidden');
            document.getElementById('paginationContainer').classList.add('hidden');
            document.getElementById('searchInput').value = '';

            fetch(`${SCRIPT_URL}?action=getRecentData&sheetId=${SHEET_ID}&page=${page}&pageSize=${PAGE_SIZE}`)
                .then(response => response.json())
                .then(data => {
                    tableLoading.classList.add('hidden');
                    tableContainer.classList.remove('hidden');
                    tableBody.innerHTML = '';
                    
                    if (data.success) {
                        currentPage = data.pagination.currentPage;
                        totalPages = data.pagination.totalPages;

                        if (data.registrations && data.registrations.length > 0) {
                            data.registrations.forEach(reg => {
                                const row = document.createElement('tr');
                                row.innerHTML = `<td>${reg.no || '-'}</td><td>${reg.name || '-'}</td><td class="no-wrap">${reg.email || '-'}</td><td>${reg.program || '-'}</td><td class="no-wrap">${formatThaiBuddhistDate(reg.timestamp)}</td>`;
                                tableBody.appendChild(row);
                            });
                        } else {
                            tableBody.innerHTML = '<tr id="noResultsRow"><td colspan="5" class="text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</td></tr>';
                        }
                        updatePaginationControls();
                    } else {
                        tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500">${data.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}</td></tr>`;
                    }
                })
                .catch(error => {
                    console.error('Error fetching registrations:', error);
                    tableLoading.classList.add('hidden');
                    tableContainer.classList.remove('hidden');
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
                });
        }
        
        function submitForm() {
            const form = document.getElementById('registrationForm');
            const loadingIndicator = document.getElementById('loadingIndicator');

            loadingIndicator.classList.remove('hidden');
            form.classList.add('hidden');
            
            const formData = new FormData(form);
            formData.append('action', 'register');
            formData.append('sheetId', SHEET_ID);
            
            fetch(SCRIPT_URL, { method: 'POST', body: formData })
            .then(response => response.json())
            .then(data => {
                loadingIndicator.classList.add('hidden');
                form.classList.remove('hidden');
                
                if (data.success) {
                    allRegistrationsData = null; // Clear dashboard cache to force reload on next view
                    let swalConfig = {
                        title: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                        html: `<p>${data.message || '‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô'}</p><p class="mt-2 font-semibold">‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà: ${data.registrationNumber || 'N/A'}</p>`,
                        icon: 'success', confirmButtonColor: '#8A2BE2', confirmButtonText: '‡∏õ‡∏¥‡∏î',
                    };
                    if (data.downloadLink) {
                        swalConfig.showCancelButton = true;
                        swalConfig.confirmButtonText = '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå';
                        swalConfig.cancelButtonText = '‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á';
                        swalConfig.focusConfirm = true;
                    }
                    Swal.fire(swalConfig).then((result) => {
                        if (result.isConfirmed && data.downloadLink) { window.open(data.downloadLink, '_blank'); }
                        form.reset();
                        document.getElementById('submitBtn').disabled = true;
                        fetchRecentRegistrations(1); // Refresh table
                    });
                } else { showError('‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', data.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ö‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á'); }
            })
            .catch(error => { console.error('Error submitting form:', error); loadingIndicator.classList.add('hidden'); form.classList.remove('hidden'); showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ'); });
        }
        
        function showError(title, message) {
            Swal.fire({ title: title, text: message, icon: 'error', confirmButtonColor: '#8A2BE2' });
        }
    </script>
</body>
</html>
